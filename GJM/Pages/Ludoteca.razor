@page "/ludoteca"
@using GJM.Data;
@using GJM.Pages.Games;
@using GJM.Services;
@using Microsoft.EntityFrameworkCore;
@inject IDbContextFactory<ApplicationDbContext> dbContextFactory

<Container>
    <Row>
        <Column ColumnSize="ColumnSize.Is6.OnDesktop.Is8.OnTablet.Is12.OnMobile">
            <Heading Size="HeadingSize.Is3">Buscar Juegos</Heading>
        </Column>
    </Row>
    <Row>
        <Column ColumnSize="ColumnSize.Is6.OnDesktop.Is8.OnTablet.Is12.OnMobile">
            <TextEdit @bind-Text="searchTerm" Placeholder="Buscar por nombre o categoria" />
        </Column>
        <Column ColumnSize="ColumnSize.Is6.OnDesktop.Is4.OnTablet.Is12.OnMobile">
            <Button Color="Color.Primary" Clicked="SearchGames">Buscar</Button>
        </Column>
    </Row>
</Container>

<Divider />

<CardDeck>
    <Row>
        @foreach (var game in games)
        {
            <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnTablet.Is4.OnDesktop.Is3">
                <Card>
                    <CardImage Source="@game.Image" Alt="@game.Name"></CardImage>
                    <CardBody>
                        <CardTitle Size="5">@game.Name</CardTitle>
                        <CardSubtitle>Categoria: @game.Category.Name</CardSubtitle>
                        <CardText>@(game.IsRented ? "Alquilado" : game.IsReserved ? "Reservado" : "Disponible")</CardText>
                        <AuthorizeView>
                            <Authorized>
                            @if (game.IsRented)
                            {                  
                                <CardText>@(game.IsRented ? $"Fecha disponibilidad: {game.ReturnDate?.ToString("MM/dd/yyyy")}" : string.Empty)</CardText>
                            }
                            @if (!game.IsReserved)
                            {
                                <Button Color="Color.Secondary" Clicked="@(()=> ShowModalReserveGame(game.Id))" class="flex-fill mr-2">Reservar</Button>
                            }
                            </Authorized>
                            <NotAuthorized>
                                    <CardText>Si quieres reservar o ver más información acerca de la disponibilidad deberás registrarte</CardText>
                            </NotAuthorized>
                        </AuthorizeView>
                    </CardBody>
                </Card>
            </Column>
        }
    </Row>
</CardDeck>
@if (games.Any())
{
    <Pagination>
        <PaginationItem Disabled="@IsPageNavigationDisabled(PREVIOUS)" @onclick="Previous">
            <PaginationLink>
                <span aria-hidden="true">«</span>
            </PaginationLink>
        </PaginationItem>
        @{
            for (var i = 1; i <= totalPages; i++)
            {
                var pageNumberAsString = i.ToString();
                <PaginationItem @key="pageNumberAsString" Active="@IsActive(pageNumberAsString)">
                    <PaginationLink Page="@pageNumberAsString" Clicked="@(async (string page) => await SetActivePage(page))">
                        @pageNumberAsString
                    </PaginationLink>
                </PaginationItem>
            }
        }
        <PaginationItem Disabled="@IsPageNavigationDisabled(NEXT)" @onclick="Next">
            <PaginationLink>
                <span aria-hidden="true">»</span>
            </PaginationLink>
        </PaginationItem>
    </Pagination>
}

@implements IDisposable

@code {
    private const string PREVIOUS = "Previous";
    private const string NEXT = "Next";
    private string searchTerm = string.Empty;
    private List<Game> games = new List<Game>();
    private int currentPage = 1;
    private int totalPages = 0;

    [Inject] public IModalService ModalService { get; set; }
    [Inject] public EventService EventService { get; set; }

    private async Task SearchGames()
    {
        using (var dbContext = dbContextFactory.CreateDbContext())
        {
            var query = dbContext.Games
                .Where(g => g.Name.Contains(searchTerm) || g.Category.Name.Contains(searchTerm)) // Update here
                .Include(g => g.User)
            .Include(g => g.Category);

            // Count total items for pagination
            var totalItems = await query.CountAsync();
            totalPages = (totalItems + 5 - 1) / 5; // 5 items per page, change as needed

            games = await query
                .Skip((currentPage - 1) * 5)
                .Take(5)
                .ToListAsync();
        }
    }

    private bool IsActive(string page) => currentPage == int.Parse(page);

    private bool IsPageNavigationDisabled(string navigation)
    {
        if (navigation.Equals(PREVIOUS))
        {
            return currentPage == 1;
        }
        else if (navigation.Equals(NEXT))
        {
            return currentPage == totalPages;
        }
        return false;
    }

    private async void Previous()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await SearchGames();
        }
    }

    private async void Next()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await SearchGames();
        }
    }

    private async Task SetActivePage(string page)
    {
        currentPage = int.Parse(page);
        await SearchGames();
    }

    private Task ShowModalReserveGame(int idGame = 0)
    {
        return ModalService.Show<ModalReserveGame>(parameters =>
        {
            parameters.Add(x => x.IdGame, idGame);
        },
        new ModalInstanceOptions() { UseModalStructure = false, Size = ModalSize.Large });

    }

    private async void UpdateGames()
    {
        await InvokeAsync(async () =>
        {
            await ShowModal("Info", "Has reservado el Juego, pasate a recorgerlo en la asociación");
            await SearchGames();
            StateHasChanged();
        });
    }

    private Task ShowModal(string title, string message)
    {
        return ModalService.Show<GenericModal>(parameters =>
        {
            parameters.Add(x => x.ModalTitle, title);
            parameters.Add(x => x.ModalBody, message);
        },
        new ModalInstanceOptions() { UseModalStructure = false });
    }

    protected override void OnInitialized()
    {
        EventService.OnGameReserve += UpdateGames;
    }
    public void Dispose()
    {
        EventService.OnGameReserve -= UpdateGames;
    }

}
